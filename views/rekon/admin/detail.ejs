<%- include('../../partials/_head.ejs') %>
<body>
  <%- include('../../partials/_navbar.ejs') %>
  <br>
  <div class="container">
    <% if (messages.success) { %>
      <div class="alert alert-info" role="alert">
        <%- messages.success %>
      </div>
    <% } %>
    <div class="row">
      <div class="col">
        <div class="table-container">
          <table class="table table-striped table-hover">
            <thead class="sticky-header">
              <tr>
                <th scope="col" class="th-no">No</th>
                <th scope="col" class="th-incident">Incident</th>
                <th scope="col" class="th-customer">Customer</th>
                <th scope="col" class="th-layanan">Layanan</th>
                <th scope="col" class="th-kategori">Kategori</th>
                <th scope="col" class="th-regional">Regional</th>
                <th scope="col" class="th-witel">Witel</th>
                <th scope="col" class="th-jenis-permintaan">
                  Jenis Permintaan
                </th>
                <th scope="col" class="th-reason">Reason</th>
                <th scope="col" class="th-ttr-e2e-awal">TTR E2E Awal</th>
                <th scope="col" class="th-ttr-after-reduksi">
                  TTR After Reduksi
                </th>
                <th scope="col" class="th-eviden-regional">Eviden Regional</th>
                <th scope="col" class="th-catatan-sda">Catatan SDA</th>
                <th scope="col" class="th-validasi-sda">Validasi SDA</th>
                <th scope="col" class="th-approved-not-ppq">
                  Approved Not PPQ
                </th>
                <th scope="col" class="th-rep-rec">Rep/Rec</th>
                <th scope="col" class="th-change-to">Change To</th>
                <th colspan="2" scope="col" class="th-aksi">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <% for(var i = 0; i < data.length; i++){ %>
                <tr>
                  <td scope="row"><%= (i + 1) %></td>
                  <td><%= data[i].incident %></td>
                  <td><%= data[i].customer %></td>
                  <td><%= data[i].layanan %></td>
                  <td><%= data[i].kategori %></td>
                  <td><%= data[i].regional %></td>
                  <td><%= data[i].witel %></td>
                  <td><%= data[i].jenis_permintaan %></td>
                  <td><%= data[i].reason %></td>
                  <td><%= data[i].ttr_e2e_awal %></td>
                  <td><%= data[i].ttr_after_reduksi %></td>
                  <td><%= data[i].eviden_regional %></td>
                  <td><%= data[i].catatan_sda %></td>
                  <td><%= data[i].validasi_sda %></td>
                  <td><%= data[i].approved_not_ppq %></td>
                  <td><%= data[i].rep_rec %></td>
                  <td><%= data[i].change_to %></td>
                  <td>
                    <% if (data[i].level_acc === 'kosong' || !data[i].level_acc) { %>
                      <button onclick="updateLevelAcc('<%= data[i].id_rekon %>', 'approve')" class="btn btn-sm btn-success"><i class="fas fa-check"></i></button>
                    <% } else if (data[i].level_acc === 'approve') { %>
                      <button class="btn btn-sm btn-success" disabled><i class="fas fa-check"></i></button>
                    <% } %>
                  </td>
                  <td>
                    <% if (data[i].level_acc === 'kosong' || !data[i].level_acc) { %>
                      <button onclick="updateLevelAcc('<%= data[i].id_rekon %>', 'reject')" class="btn btn-sm btn-danger"><i class="fas fa-times"></i> </button>
                    <% } else if (data[i].level_acc === 'reject') { %>
                      <button class="btn btn-sm btn-danger" disabled><i class="fas fa-times"></i></button>
                    <% } %>
                  </td>                                                     
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <%- include('../../partials/_foot.ejs') %>

  <script>
    async function updateLevelAcc(id, levelAcc) {
    try {
        const response = await fetch(`/rekon/admin/detail/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ level_acc: levelAcc })
        });

        const result = await response.json();
        if (response.ok) {
            alert(result.message);

            // Menggunakan `window.location.reload()` untuk memuat ulang halaman dan menampilkan data terbaru
            window.location.reload(); // Ini untuk memastikan kondisi yang terbaru muncul setelah update
        } else {
            alert(result.error);
        }
    } catch (err) {
        console.error("Error updating level_acc:", err);
        alert("Failed to update level_acc. Please try again.");
    }
}

    </script>
</body>
