<%- include('../../partials/_head.ejs') %>
<body>
  <%- include('../../partials/_navbar.ejs') %>
  <br>
  <div class="container">
    <% if (messages.success) { %>
      <div class="alert alert-info" role="alert">
        <%- messages.success %>
      </div>
    <% } %>
    <div class="row">
      <div class="col">
        <div class="table-container">
          <table class="table table-striped table-hover">
            <thead class="thead-dark sticky-header">
              <tr>
                <th scope="col">No</th>
                <th scope="col">Incident</th>
                <th scope="col">Customer</th>
                <th scope="col">Layanan</th>
                <th scope="col">Kategori</th>
                <th scope="col">Regional</th>
                <th scope="col">Witel</th>
                <th scope="col">Jenis Permintaan</th>
                <th scope="col">Reason</th>
                <th scope="col">TTR E2E Awal</th>
                <th scope="col">TTR After Reduksi</th>
                <th scope="col">Eviden Regional</th>
                <th scope="col">Catatan SDA</th>
                <th scope="col">Validasi SDA</th>
                <th scope="col">Approved Not PPQ</th>
                <th scope="col">REP REC</th>
                <th scope="col">Change To</th>
                <th scope="col">Status</th>
                <th colspan="2" scope="col">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <% for(var i = 0; i < data.length; i++){ %>
                <tr>
                  <td scope="row"><%= (i + 1) %></td>
                  <td><%= data[i].incident %></td>
                  <td><%= data[i].customer %></td>
                  <td><%= data[i].layanan %></td>
                  <td><%= data[i].kategori %></td>
                  <td><%= data[i].regional %></td>
                  <td><%= data[i].witel %></td>
                  <td><%= data[i].jenis_permintaan %></td>
                  <td><%= data[i].reason %></td>
                  <td><%= data[i].ttr_e2e_awal %></td>
                  <td><%= data[i].ttr_after_reduksi %></td>
                  <td><%= data[i].eviden_regional %></td>
                  <td><%= data[i].catatan_sda %></td>
                  <td><%= data[i].validasi_sda %></td>
                  <td><%= data[i].approved_not_ppq %></td>
                  <td><%= data[i].rep_rec %></td>
                  <td><%= data[i].change_to %></td>
                  <td><%= data[i].level_acc %></td>
                  <td>
                    <% if (data[i].level_acc === 'approve') { %>
                      <button class="btn btn-sm btn-secondary" disabled>Approved</button>
                    <% } else { %>
                      <button onclick="updateLevelAcc('<%= data[i].id_rekon %>', 'approve')" class="btn btn-sm btn-success"><i class="fas fa-check"></i> Approve</button>
                    <% } %>
                  </td>
                  <td>
                    <% if (data[i].level_acc === 'reject') { %>
                      <button class="btn btn-sm btn-secondary" disabled>Rejected</button>
                    <% } else { %>
                      <button onclick="updateLevelAcc('<%= data[i].id_rekon %>', 'reject')" class="btn btn-sm btn-danger"><i class="fas fa-times"></i> Reject</button>
                    <% } %>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <%- include('../../partials/_foot.ejs') %>

  <script>
    async function updateLevelAcc(id, levelAcc) {
        try {
            const response = await fetch(`/rekon/admin/detail/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ level_acc: levelAcc })
            });
    
            const result = await response.json();
            if (response.ok) {
                alert(result.message);
    
                // Mendapatkan elemen tombol berdasarkan id_rekon
                const buttonApprove = document.querySelector(`button[onclick="updateLevelAcc('${id}', 'approve')"]`);
                const buttonReject = document.querySelector(`button[onclick="updateLevelAcc('${id}', 'reject')"]`);
    
                // Memperbarui tombol berdasarkan levelAcc
                if (levelAcc === 'approve') {
                    if (buttonApprove) {
                        buttonApprove.classList.remove('btn-success');
                        buttonApprove.classList.add('btn-secondary');
                        buttonApprove.textContent = 'Approved';
                        buttonApprove.disabled = true;
                    }
                    if (buttonReject) {
                        buttonReject.classList.add('d-none'); // Menyembunyikan tombol reject
                    }
                } else if (levelAcc === 'reject') {
                    if (buttonReject) {
                        buttonReject.classList.remove('btn-danger');
                        buttonReject.classList.add('btn-secondary');
                        buttonReject.textContent = 'Rejected';
                        buttonReject.disabled = true;
                    }
                    if (buttonApprove) {
                        buttonApprove.classList.add('d-none'); // Menyembunyikan tombol approve
                    }
                }
            } else {
                alert(result.error);
            }
        } catch (err) {
            console.error("Error updating level_acc:", err);
            alert("Failed to update level_acc. Please try again.");
        }
    }
    </script>
    
  <!-- Inline CSS -->
  <style>
    .table-container {
      max-height: 600px;
      overflow: auto; /* Allows scrolling but hides scrollbar */
    }

    .table-container::-webkit-scrollbar {
      display: none; /* Hides scrollbar for WebKit browsers (Chrome, Safari) */
    }

    .sticky-header th {
      position: -webkit-sticky; /* For Safari */
      position: sticky;
      top: 0;
      background-color: #343a40; /* Same color as thead-dark */
      color: white;
      z-index: 10; /* Ensures the header is above other content */
    }
  </style>
</body>
